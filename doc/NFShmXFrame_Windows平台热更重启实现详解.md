# NFShmXFrame Windowså¹³å°çƒ­æ›´é‡å¯å®ç°è¯¦è§£

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸“é—¨è¯¦ç»†ä»‹ç»NFShmXFrameåœ¨Windowså¹³å°ä¸Šçš„`--restart`çƒ­æ›´é‡å¯åŠŸèƒ½å®ç°ã€‚ç”±äºWindowså’ŒLinuxåœ¨è¿›ç¨‹ç®¡ç†å’Œå…±äº«å†…å­˜ç”Ÿå‘½å‘¨æœŸæ–¹é¢çš„å·®å¼‚ï¼ŒWindowså¹³å°é‡‡ç”¨äº†ç‹¬ç‰¹çš„åŒå‘ç¡®è®¤æœºåˆ¶æ¥ç¡®ä¿æ•°æ®å®‰å…¨å’Œé‡å¯å¯é æ€§ã€‚

**ğŸš¨ é‡è¦é£é™©è­¦å‘Š**ï¼š
- **Windowså¹³å°çƒ­æ›´é‡å¯å­˜åœ¨ä¸¥é‡çš„æ•°æ®ä¸¢å¤±é£é™©**
- **ä»…ä¾›å¼€å‘è°ƒè¯•æœŸé—´ä½¿ç”¨ï¼Œä¸¥ç¦ç”¨äºç”Ÿäº§ç¯å¢ƒ**
- **ä¸€æ—¦å‡ºç°å¼‚å¸¸å¯èƒ½å¯¼è‡´æ‰€æœ‰æ¸¸æˆæ•°æ®å®Œå…¨ä¸¢å¤±**
- **ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨ä¼ ç»Ÿåœæœæ›´æ–°æ–¹å¼æˆ–è¿ç§»åˆ°Linuxå¹³å°**

**é€‚ç”¨åœºæ™¯é™åˆ¶**ï¼š
- âœ… **å¼€å‘è°ƒè¯•**ï¼šä»£ç æµ‹è¯•ã€åŠŸèƒ½éªŒè¯
- âœ… **æœ¬åœ°æµ‹è¯•**ï¼šä¸ªäººå¼€å‘ç¯å¢ƒæµ‹è¯•
- âŒ **ç”Ÿäº§ç¯å¢ƒ**ï¼šç»å¯¹ç¦æ­¢ä½¿ç”¨
- âŒ **é¢„ç”Ÿäº§ç¯å¢ƒ**ï¼šä¸å»ºè®®ä½¿ç”¨
- âŒ **åŒ…å«é‡è¦æ•°æ®çš„ç¯å¢ƒ**ï¼šä¸¥ç¦ä½¿ç”¨

## ä¸€ã€Windowså¹³å°ç‰¹æ®ŠæŒ‘æˆ˜

### 1.1 å…±äº«å†…å­˜ç”Ÿå‘½å‘¨æœŸé—®é¢˜

**æ ¸å¿ƒé—®é¢˜**ï¼š
- Linuxï¼šå…±äº«å†…å­˜å¯¹è±¡ç‹¬ç«‹äºè¿›ç¨‹å­˜åœ¨ï¼Œè¿›ç¨‹ç»ˆæ­¢åå…±äº«å†…å­˜ä¾ç„¶å­˜åœ¨
- Windowsï¼šå…±äº«å†…å­˜å¯¹è±¡ç»‘å®šåˆ°è¿›ç¨‹ï¼Œè¿›ç¨‹ç»ˆæ­¢æ—¶è‡ªåŠ¨é‡Šæ”¾å…±äº«å†…å­˜

**ä¸¥é‡é£é™©**ï¼š
- **æ•°æ®å®Œå…¨ä¸¢å¤±**ï¼šWindowsç³»ç»Ÿåœ¨è¿›ç¨‹ç»ˆæ­¢æ—¶ä¼šç«‹å³é‡Šæ”¾å…±äº«å†…å­˜ï¼Œä»»ä½•å¼‚å¸¸éƒ½å¯èƒ½å¯¼è‡´æ•°æ®å…¨éƒ¨ä¸¢å¤±
- **ä¸å¯é¢„æµ‹æ€§**ï¼šWindowså…±äº«å†…å­˜çš„é‡Šæ”¾æ—¶æœºä¸å¯æ§ï¼Œå®¹æ˜“å—ç³»ç»Ÿè´Ÿè½½ã€é˜²ç—…æ¯’è½¯ä»¶ç­‰å½±å“
- **æ¢å¤å›°éš¾**ï¼šä¸€æ—¦æ•°æ®ä¸¢å¤±ï¼Œé€šå¸¸æ— æ³•æ¢å¤ï¼Œä¸¥é‡å½±å“å¼€å‘è¿›åº¦
- **ç¨³å®šæ€§å·®**ï¼šWindowså¹³å°çš„å…±äº«å†…å­˜æœºåˆ¶è¿œä¸å¦‚Linuxç¨³å®šå¯é 

**å½±å“**ï¼š
- ä¼ ç»Ÿçš„"æ€æ­»æ—§è¿›ç¨‹â†’å¯åŠ¨æ–°è¿›ç¨‹"æ–¹å¼åœ¨Windowsä¸Šä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±
- éœ€è¦ç‰¹æ®Šæœºåˆ¶ç¡®ä¿æ•°æ®åœ¨è¿›ç¨‹åˆ‡æ¢è¿‡ç¨‹ä¸­ä¸ä¸¢å¤±
- å³ä½¿æœ‰åŒå‘ç¡®è®¤æœºåˆ¶ï¼Œä»ç„¶å­˜åœ¨æ•°æ®ä¸¢å¤±çš„é£é™©
- ç³»ç»Ÿå¼‚å¸¸ã€æ–­ç”µã€è“å±ç­‰æƒ…å†µä¸‹å¿…ç„¶å¯¼è‡´æ•°æ®ä¸¢å¤±

**ä¸ºä»€ä¹ˆä¸å»ºè®®ç”Ÿäº§ä½¿ç”¨**ï¼š
1. **æ•°æ®å®‰å…¨æ€§æ— æ³•ä¿è¯**ï¼šä»»ä½•ç³»ç»Ÿå¼‚å¸¸éƒ½å¯èƒ½å¯¼è‡´ç¾éš¾æ€§æ•°æ®ä¸¢å¤±
2. **ä¾èµ–å¤æ‚æ—¶åº**ï¼šåŒå‘ç¡®è®¤æœºåˆ¶å¤æ‚ï¼Œå®¹æ˜“å‡ºç°æ—¶åºé—®é¢˜
3. **ç³»ç»Ÿå…¼å®¹æ€§é—®é¢˜**ï¼šä¸åŒWindowsç‰ˆæœ¬è¡Œä¸ºå¯èƒ½ä¸ä¸€è‡´
4. **ç›‘æ§å›°éš¾**ï¼šéš¾ä»¥å‡†ç¡®ç›‘æ§å’Œé¢„æµ‹æ½œåœ¨é£é™©
5. **æ¢å¤æˆæœ¬é«˜**ï¼šæ•°æ®ä¸¢å¤±åçš„æ¢å¤æˆæœ¬å’Œæ—¶é—´æˆæœ¬æé«˜

### 1.2 è¿›ç¨‹é—´é€šä¿¡å·®å¼‚

**Linuxæ–¹å¼**ï¼š
```cpp
// ä½¿ç”¨ä¿¡å·è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡
kill(proc_id, SIGUNUSED);  // å‘é€ä¿¡å·
```

**Windowsæ–¹å¼**ï¼š
```cpp
// ä½¿ç”¨å‘½åäº‹ä»¶è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡
HANDLE hEvent = CreateEventA(NULL, FALSE, FALSE, eventName.c_str());
SetEvent(hEvent);  // è§¦å‘äº‹ä»¶
```

## äºŒã€WindowsåŒå‘ç¡®è®¤æœºåˆ¶è®¾è®¡

### 2.1 è®¾è®¡åŸç†

ä¸ºäº†è§£å†³Windowså¹³å°çš„å…±äº«å†…å­˜ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼ŒNFShmXFrameè®¾è®¡äº†ç‹¬ç‰¹çš„åŒå‘ç¡®è®¤æœºåˆ¶ï¼š

1. **ç¨‹åºAï¼ˆæ–°è¿›ç¨‹ï¼‰**ï¼šå‘é€Killä¿¡å·ï¼Œç­‰å¾…ç¡®è®¤
2. **ç¨‹åºBï¼ˆæ—§è¿›ç¨‹ï¼‰**ï¼šæ”¶åˆ°ä¿¡å·åä¼˜é›…é€€å‡ºï¼Œå‘é€ç¡®è®¤ä¿¡å·
3. **ç¨‹åºA**ï¼šæ”¶åˆ°ç¡®è®¤åç­‰å¾…è¿›ç¨‹å®Œå…¨é€€å‡ºï¼Œç„¶åå¯åŠ¨

### 2.2 äº‹ä»¶å‘½åè§„èŒƒ

```cpp
// Killä¿¡å·äº‹ä»¶åç§°
std::string killEventName = "NFServer_Kill_" + std::to_string(processId);

// KillæˆåŠŸç¡®è®¤äº‹ä»¶åç§°  
std::string killSuccessEventName = "NFServer_KillSuccess_" + std::to_string(processId);

// å…¶ä»–äº‹ä»¶ç±»å‹
std::string reloadEventName = "NFServer_Reload_" + std::to_string(processId);
std::string stopEventName = "NFServer_Stop_" + std::to_string(processId);
std::string quitEventName = "NFServer_Quit_" + std::to_string(processId);
```

### 2.3 å®Œæ•´æµç¨‹å›¾

**Windowså¹³å°åŒå‘ç¡®è®¤æœºåˆ¶è¯¦ç»†æµç¨‹å›¾**ï¼š

```
ç¨‹åºAï¼ˆæ–°è¿›ç¨‹ï¼‰ç«¯ï¼š                    ç¨‹åºBï¼ˆæ—§è¿›ç¨‹ï¼‰ç«¯ï¼š
                                      
å¯åŠ¨é‡å¯å‘½ä»¤                          äº‹ä»¶å¤„ç†çº¿ç¨‹
     â”‚                               EventHandlingThread
     â–¼                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â–¼
â”‚æ£€æŸ¥PIDæ–‡ä»¶ï¼Ÿâ”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚è½®è¯¢æ£€æŸ¥Killäº‹ä»¶  â”‚
      â”‚                              â”‚CheckEventæ¯10ms  â”‚
 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    å¦   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”‚æ–‡ä»¶å­˜åœ¨ï¼Ÿâ”‚ â”€â”€â”€â”€â–¶  â”‚ç›´æ¥å¯åŠ¨æ–°è¿›ç¨‹â”‚        â”‚
 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â–¼
      â”‚æ˜¯                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â–¼                                  â”‚æ£€æµ‹åˆ°Kill   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚äº‹ä»¶ï¼Ÿ        â”‚
â”‚è¯»å–æ—§è¿›ç¨‹PID â”‚                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚å¦
       â”‚                                       â–¼
       â–¼                                    â”Œâ”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚å¾ªç¯ â”‚
â”‚OpenProcessæ£€æŸ¥   â”‚   ä¸å­˜åœ¨              â”‚ç­‰å¾… â”‚
â”‚æ—§è¿›ç¨‹æ˜¯å¦è¿è¡Œï¼Ÿ  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â””â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚        â”‚æ˜¯
       â”‚                                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                                       â”‚  â”‚è®¾ç½®åœæœæ ‡å¿—      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚SetServerStopping â”‚
â”‚åˆ›å»ºKilläº‹ä»¶      â”‚                         â”‚  â”‚SetServerKilling  â”‚
â”‚NFServer_Kill_PID â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚         â”‚
       â”‚                                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                                       â”‚  â”‚æ£€æŸ¥æ‰€æœ‰æœåŠ¡      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚æ˜¯å¦åœæ­¢ï¼Ÿ        â”‚
â”‚SetEventå‘é€      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–¶â”‚æ˜¯å¦åœæ­¢ï¼Ÿ        â”‚
â”‚Killä¿¡å·          â”‚                         â”‚  â”‚æœ€å¤š10ç§’è¶…æ—¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â”‚æœ€å¤š10ç§’è¶…æ—¶      â”‚
       â”‚                                       â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–¼                                       â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Sleep(50ms)       â”‚                         â”‚    â”‚åœæ­¢/è¶…æ—¶â”‚
â”‚é¿å…ç«æ€æ¡ä»¶      â”‚                         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚         â”‚
       â”‚                                       â”‚         â–¼
       â–¼                                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚ç¡®ä¿æ•°æ®ä¿å­˜åˆ°    â”‚
â”‚CloseHandleå…³é—­   â”‚                         â”‚  â”‚å…±äº«å†…å­˜          â”‚
â”‚Killäº‹ä»¶          â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚         â”‚
       â”‚                                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”‚å‘é€KillSuccess   â”‚
â”‚åˆ›å»ºKillSuccess   â”‚                         â”‚  â”‚ç¡®è®¤äº‹ä»¶          â”‚
â”‚äº‹ä»¶              â”‚                         â”‚  â”‚SetEvent()        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                       â”‚         â”‚
       â–¼                                       â”‚         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚WaitForSingleObj  â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”‚Sleep(50ms)       â”‚
â”‚ç­‰å¾…ç¡®è®¤ä¿¡å·      â”‚                         â”‚  â”‚ç¡®ä¿ä¿¡å·ä¼ é€’      â”‚
â”‚è¶…æ—¶15ç§’          â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚         â”‚
       â”‚                                       â”‚         â–¼
  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ç­‰å¾…ç»“æœï¼Ÿâ”‚                        â”‚  â”‚Sleep(10ç§’)       â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                        â”‚  â”‚ç­‰å¾…å¯¹æ–¹å¯åŠ¨      â”‚
       â”‚                             â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                      â”‚         â”‚
â”‚WAIT_OBJECT_0â”‚                      â”‚         â–¼
â”‚æ”¶åˆ°ç¡®è®¤     â”‚                      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚CloseHandle       â”‚
       â”‚                             â”‚  â”‚å…³é—­äº‹ä»¶          â”‚
       â–¼                             â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚         â”‚
â”‚ä»å…±äº«å†…å­˜æ¢å¤â”‚                     â”‚         â–¼
â”‚æ•°æ®çŠ¶æ€ï¼ˆç«‹å³å¼€å§‹ï¼‰â”‚                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚exit(0)           â”‚
       â”‚                             â”‚  â”‚æ­£å¸¸é€€å‡º          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚é‡å¯å®Œæˆ      â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Windowsäº‹ä»¶ç³»ç»Ÿï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚NFServer_Kill_{PID}          â”‚ â—€â”€â”€â”€ ç¨‹åºAåˆ›å»ºå’Œè§¦å‘
â”‚NFServer_KillSuccess_{PID}   â”‚ â—€â”€â”€â”€ ç¨‹åºBåˆ›å»ºå’Œè§¦å‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…±äº«å†…å­˜ç³»ç»Ÿï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ¸¸æˆæ•°æ®æŒä¹…åŒ–å­˜å‚¨           â”‚ â—€â”€â”€â”€ ç¨‹åºBä¿å­˜ï¼Œç¨‹åºAæ¢å¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ—¶åºè¯´æ˜**ï¼š

1. **å¹¶å‘æ‰§è¡Œ**ï¼šç¨‹åºAå’Œç¨‹åºBçš„æŸäº›æ­¥éª¤æ˜¯å¹¶å‘æ‰§è¡Œçš„
2. **äº‹ä»¶åŒæ­¥**ï¼šé€šè¿‡Windowsäº‹ä»¶ç³»ç»Ÿå®ç°è¿›ç¨‹é—´åŒæ­¥
3. **è¶…æ—¶ä¿æŠ¤**ï¼šå¤šå±‚è¶…æ—¶æœºåˆ¶ç¡®ä¿ä¸ä¼šæ­»é”
4. **æ•°æ®å®‰å…¨**ï¼šå…±äº«å†…å­˜æ•°æ®åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å¾—åˆ°ä¿æŠ¤

**æ—¶é—´çº¿åˆ†æ**ï¼š

```
æ—¶é—´è½´ï¼ˆæ¯«ç§’ï¼‰ï¼š
0ms    â”Œâ”€ ç¨‹åºAå¯åŠ¨æ£€æŸ¥
100ms  â”œâ”€ åˆ›å»ºKilläº‹ä»¶
200ms  â”œâ”€ å‘é€Killä¿¡å·
250ms  â”œâ”€ å»¶è¿Ÿé¿å…ç«æ€
300ms  â”œâ”€ å¼€å§‹ç­‰å¾…ç¡®è®¤
       â”‚
400ms  â”œâ”€ ç¨‹åºBæ£€æµ‹åˆ°äº‹ä»¶
500ms  â”œâ”€ è®¾ç½®åœæœæ ‡å¿—
10500msâ”œâ”€ æœåŠ¡åœæ­¢æ£€æŸ¥å®Œæˆ
10550msâ”œâ”€ å‘é€ç¡®è®¤ä¿¡å·
10600msâ”œâ”€ ç¨‹åºAæ”¶åˆ°ç¡®è®¤ï¼Œç«‹å³å¼€å§‹æ¢å¤æ•°æ®
10700msâ”œâ”€ ç¨‹åºAå¼€å§‹åˆå§‹åŒ–å¹¶å¯åŠ¨æœåŠ¡
       â”‚   ï¼ˆä¸ç¨‹åºBçš„10ç§’ç­‰å¾…å¹¶è¡Œè¿›è¡Œï¼‰
12700msâ”œâ”€ ç¨‹åºAå¯åŠ¨å®Œæˆ
       â”‚
20600msâ”œâ”€ ç¨‹åºBå®Œå…¨é€€å‡º
20700msâ””â”€ é‡å¯å®Œæˆ

å…³é”®æ—¶é—´ç‚¹ï¼š
- ç«æ€ä¿æŠ¤æœŸï¼š250ms - 300ms
- åŒå‘ç¡®è®¤æœŸï¼š10500ms - 10600ms
- å¹¶è¡Œå¤„ç†æœŸï¼š10600ms - 20600msï¼ˆç¨‹åºAå¯åŠ¨ä¸ç¨‹åºBé€€å‡ºå¹¶è¡Œï¼‰
- æ•°æ®æ¢å¤æœŸï¼š10600ms - 10700msï¼ˆç«‹å³å¼€å§‹ï¼‰
- æœåŠ¡å¯åŠ¨æœŸï¼š10700ms - 12700msï¼ˆä¸ç¨‹åºBé€€å‡ºå¹¶è¡Œï¼‰
```

## ä¸‰ã€æ ¸å¿ƒå®ç°ä»£ç è¯¦è§£

### 3.1 ç¨‹åºAç«¯å®ç°ï¼ˆNFCPluginManager::KillPreAppï¼‰

```cpp
int NFCPluginManager::KillPreApp()
{
    bool exist = NFFileUtility::IsFileExist(m_strPidFileName);
    if (exist)
    {
        std::string content;
        // è¯»å–PIDæ–‡ä»¶å†…å®¹
        NFFileUtility::ReadFileContent(m_strPidFileName, content);
        
        // è½¬æ¢ä¸ºWindowsè¿›ç¨‹ID
        DWORD proc_id = NFCommon::strto<DWORD>(content);
        
        // 1. æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
        HANDLE hProcess = OpenProcess(SYNCHRONIZE, FALSE, proc_id);
        if (hProcess == NULL)
        {
            // è¿›ç¨‹ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›æˆåŠŸ
            return 0;
        }
        CloseHandle(hProcess);

        // 2. å‘é€Killä¿¡å·ç»™ç¨‹åºB
        std::string killEventName = "NFServer_Kill_" + std::to_string(proc_id);
        HANDLE hKillEvent = CreateEventA(NULL, FALSE, FALSE, killEventName.c_str());

        if (hKillEvent != NULL)
        {
            NFLogInfo(NF_LOG_DEFAULT, 0, "Sending kill signal to process {}", proc_id);

            // è®¾ç½®æ€æ­»äº‹ä»¶ï¼Œé€šçŸ¥ç›®æ ‡è¿›ç¨‹å¼€å§‹é‡Šæ”¾èµ„æº
            SetEvent(hKillEvent);
            
            // 3. ç­‰å¾…è¶³å¤Ÿæ—¶é—´ç¡®ä¿æ¥æ”¶æ–¹èƒ½å¤„ç†äº‹ä»¶ï¼Œé¿å…ç«æ€æ¡ä»¶
            Sleep(50);
            CloseHandle(hKillEvent);

            // 4. ç­‰å¾…ç¨‹åºBè¿”å›killæˆåŠŸä¿¡å·
            std::string killSuccessEventName = "NFServer_KillSuccess_" + std::to_string(proc_id);
            HANDLE hKillSuccessEvent = CreateEventA(NULL, FALSE, FALSE, killSuccessEventName.c_str());

            if (hKillSuccessEvent != NULL)
            {
                NFLogInfo(NF_LOG_DEFAULT, 0, "Waiting for kill success signal from process {}", proc_id);

                // ç­‰å¾…ç¨‹åºBå‘é€killæˆåŠŸä¿¡å·ï¼Œæœ€å¤šç­‰å¾…15ç§’
                DWORD waitResult = WaitForSingleObject(hKillSuccessEvent, 15000);
                CloseHandle(hKillSuccessEvent);

                if (waitResult == WAIT_OBJECT_0)
                {
                    NFLogInfo(NF_LOG_DEFAULT, 0, "Received kill success signal from process {}, resources released gracefully", proc_id);
                    return 0;  // æˆåŠŸ
                }
                else if (waitResult == WAIT_TIMEOUT)
                {
                    NFLogWarning(NF_LOG_DEFAULT, 0, "Timeout waiting for kill success signal from process {}, proceeding anyway", proc_id);
                    return -1;  // è¶…æ—¶å¤±è´¥
                }
                else
                {
                    NFLogError(NF_LOG_DEFAULT, 0, "Error waiting for kill success signal from process {}, error: {}", proc_id, GetLastError());
                    return -1;  // é”™è¯¯å¤±è´¥
                }
            }
        }
    }

    return 0;  // æ²¡æœ‰æ—§è¿›ç¨‹
}
```

### 3.2 ç¨‹åºBç«¯å®ç°ï¼ˆNFSignalHandlerMgrï¼‰

#### 3.2.1 äº‹ä»¶å¤„ç†çº¿ç¨‹

```cpp
class NFSignalHandlerMgr : public NFSingleton<NFSignalHandlerMgr>
{
public:
    bool Initialize()
    {
        if (m_bRunning.load())
        {
            return false; // å·²ç»åœ¨è¿è¡Œ
        }

        m_processId = GetCurrentProcessId();
        m_bRunning.store(true);

        // å¯åŠ¨äº‹ä»¶å¤„ç†çº¿ç¨‹
        m_eventThread = std::thread(&NFSignalHandlerMgr::EventHandlingThread, this);

        return true;
    }

    void EventHandlingThread()
    {
        while (m_bRunning.load())
        {
            // æ£€æŸ¥é‡è½½äº‹ä»¶
            std::string reloadEventName = "NFServer_Reload_" + std::to_string(m_processId);
            CheckEvent(reloadEventName, [this]()
            {
                NFGlobalSystem::Instance()->SetReloadServer(true);
            });

            // æ£€æŸ¥åœæ­¢äº‹ä»¶
            std::string stopEventName = "NFServer_Stop_" + std::to_string(m_processId);
            CheckEvent(stopEventName, [this]()
            {
                NFGlobalSystem::Instance()->SetServerStopping(true);
            });

            // æ£€æŸ¥é€€å‡ºäº‹ä»¶
            std::string quitEventName = "NFServer_Quit_" + std::to_string(m_processId);
            CheckEvent(quitEventName, [this]()
            {
                NFGlobalSystem::Instance()->SetServerStopping(true);
                NFGlobalSystem::Instance()->SetServerKilling(true);
            });

            // æ£€æŸ¥æ€æ­»äº‹ä»¶ï¼ˆç¨‹åºBæ”¶åˆ°ç¨‹åºAçš„killä¿¡å·ï¼‰
            std::string killEventName = "NFServer_Kill_" + std::to_string(m_processId);
            CheckEvent(killEventName, [this]()
            {
                NFLogInfo(NF_LOG_DEFAULT, 0, "Received kill signal from new process, starting graceful shutdown...");

                // ç¨‹åºBå¼€å§‹æ­£å¸¸é‡Šæ”¾èµ„æº
                NFGlobalSystem::Instance()->SetServerStopping(true);
                NFGlobalSystem::Instance()->SetServerKilling(true);
            });

            // ä¼‘çœ ä¸€å°æ®µæ—¶é—´ä»¥é¿å…è¿‡åº¦å ç”¨CPU
            std::this_thread::sleep_for(std::chrono::milliseconds(10));
        }
    }

private:
    std::thread m_eventThread;
    std::atomic<bool> m_bRunning{false};
    DWORD m_processId = 0;
};
```

#### 3.2.2 äº‹ä»¶æ£€æŸ¥å‡½æ•°

```cpp
bool NFSignalHandlerMgr::CheckEvent(const std::string& eventName, std::function<void()> callback)
{
    HANDLE hEvent = OpenEventA(EVENT_ALL_ACCESS, FALSE, eventName.c_str());
    if (hEvent != NULL)
    {
        DWORD waitResult = WaitForSingleObject(hEvent, 0);  // éé˜»å¡æ£€æŸ¥
        if (waitResult == WAIT_OBJECT_0)
        {
            // è§¦å‘å›è°ƒå‡½æ•°
            callback();
            ResetEvent(hEvent);  // é‡ç½®äº‹ä»¶çŠ¶æ€
            CloseHandle(hEvent);
            return true;
        }
        CloseHandle(hEvent);
    }
    return false;
}
```

#### 3.2.3 å‘é€KillæˆåŠŸä¿¡å·

```cpp
int NFSignalHandlerMgr::SendKillSuccess()
{
    // ç¨‹åºBå‘é€killæˆåŠŸä¿¡å·ç»™ç¨‹åºA
    std::string killSuccessEventName = "NFServer_KillSuccess_" + std::to_string(m_processId);
    HANDLE hKillSuccessEvent = CreateEventA(NULL, FALSE, FALSE, killSuccessEventName.c_str());
    
    if (hKillSuccessEvent != NULL)
    {
        SetEvent(hKillSuccessEvent);
        
        // ç­‰å¾…è¶³å¤Ÿæ—¶é—´ç¡®ä¿æ¥æ”¶æ–¹èƒ½å¤„ç†äº‹ä»¶ï¼Œé¿å…ç«æ€æ¡ä»¶
        Sleep(50);
        CloseHandle(hKillSuccessEvent);
        
        NFLogInfo(NF_LOG_DEFAULT, 0, "Kill success signal sent to new process");

        // ç­‰å¾…å¯¹æ–¹å¯åŠ¨ï¼Œä½¿å…±äº«å†…å­˜ç”Ÿæ•ˆ
        Sleep(10000);
    }
    else
    {
        NFLogError(NF_LOG_DEFAULT, 0, "Failed to create kill success event, error: {}", GetLastError());
        return -1;
    }
    
    return 0;
}
```

### 3.3 ä¼˜é›…é€€å‡ºé›†æˆ

```cpp
// åœ¨NFSignalHandlerMgrçš„ReleaseInstanceä¸­è°ƒç”¨
void NFSignalHandlerMgr::ReleaseInstance()
{
    if (m_instance)
    {
        // åœ¨é‡Šæ”¾å®ä¾‹ä¹‹å‰å‘é€killæˆåŠŸä¿¡å·
        m_instance->SendKillSuccess();
        
        // é‡Šæ”¾å®ä¾‹
        delete m_instance;
        m_instance = nullptr;
    }
}
```

## å››ã€ç«æ€æ¡ä»¶å¤„ç†

### 4.1 é—®é¢˜æè¿°

åœ¨Windowsäº‹ä»¶æœºåˆ¶ä¸­ï¼Œå¦‚æœåœ¨`SetEvent()`åç«‹å³è°ƒç”¨`CloseHandle()`ï¼Œå¯èƒ½ä¼šå‡ºç°æ¥æ”¶æ–¹è¿˜æ²¡æ¥å¾—åŠå¤„ç†äº‹ä»¶å°±è¢«å…³é—­çš„æƒ…å†µã€‚

### 4.2 è§£å†³æ–¹æ¡ˆ

#### å‘é€ç«¯å»¶è¿Ÿå¤„ç†
```cpp
// è®¾ç½®äº‹ä»¶
SetEvent(hKillEvent);

// ç­‰å¾…è¶³å¤Ÿæ—¶é—´ç¡®ä¿æ¥æ”¶æ–¹èƒ½å¤„ç†äº‹ä»¶
Sleep(50);  // 50æ¯«ç§’å»¶è¿Ÿ

// å…³é—­å¥æŸ„
CloseHandle(hKillEvent);
```

#### æ¥æ”¶ç«¯è½®è¯¢æ£€æŸ¥
```cpp
void EventHandlingThread()
{
    while (m_bRunning.load())
    {
        // æ£€æŸ¥å„ç§äº‹ä»¶
        CheckAllEvents();
        
        // çŸ­æš‚ä¼‘çœ ï¼Œé¿å…è¿‡åº¦å ç”¨CPU
        std::this_thread::sleep_for(std::chrono::milliseconds(10));
    }
}
```

## äº”ã€è¶…æ—¶å’Œé”™è¯¯å¤„ç†

### 5.1 è¶…æ—¶æœºåˆ¶è®¾è®¡

```cpp
// ç¨‹åºAç­‰å¾…ç¨‹åºBç¡®è®¤çš„è¶…æ—¶æ—¶é—´
const DWORD KILL_SUCCESS_TIMEOUT = 15000;  // 15ç§’

// ç¨‹åºBè‡ªåŠ¨é€€å‡ºçš„è¶…æ—¶æ—¶é—´
const DWORD AUTO_EXIT_TIMEOUT = 10000;     // 10ç§’

// äº‹ä»¶å¤„ç†å»¶è¿Ÿæ—¶é—´
const DWORD EVENT_PROCESS_DELAY = 50;      // 50æ¯«ç§’
```

### 5.2 é”™è¯¯å¤„ç†ç­–ç•¥

```cpp
// è¶…æ—¶å¤„ç†
if (waitResult == WAIT_TIMEOUT)
{
    NFLogWarning(NF_LOG_DEFAULT, 0, "Timeout waiting for kill success signal from process {}, proceeding anyway", proc_id);
    return -1;  // è¿”å›å¤±è´¥ï¼Œä½†ä¸é˜»æ­¢å¯åŠ¨
}

// ç³»ç»Ÿé”™è¯¯å¤„ç†
if (waitResult == WAIT_FAILED)
{
    DWORD error = GetLastError();
    NFLogError(NF_LOG_DEFAULT, 0, "Error waiting for kill success signal from process {}, error: {}", proc_id, error);
    return -1;  // è¿”å›å¤±è´¥
}
```

## å…­ã€æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§

### 6.1 æ€§èƒ½ä¼˜åŒ–æªæ–½

#### å‡å°‘äº‹ä»¶æ£€æŸ¥é¢‘ç‡
```cpp
// ä½¿ç”¨é€‚å½“çš„ä¼‘çœ æ—¶é—´ï¼Œå¹³è¡¡å“åº”æ€§å’ŒCPUä½¿ç”¨ç‡
std::this_thread::sleep_for(std::chrono::milliseconds(10));
```

#### äº‹ä»¶å¥æŸ„å¤ç”¨
```cpp
// é¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯äº‹ä»¶å¥æŸ„
class EventManager
{
private:
    std::map<std::string, HANDLE> m_eventHandles;
    
public:
    HANDLE GetOrCreateEvent(const std::string& eventName)
    {
        auto it = m_eventHandles.find(eventName);
        if (it != m_eventHandles.end())
        {
            return it->second;
        }
        
        HANDLE hEvent = CreateEventA(NULL, FALSE, FALSE, eventName.c_str());
        m_eventHandles[eventName] = hEvent;
        return hEvent;
    }
};
```

### 6.2 ç›‘æ§å’Œæ—¥å¿—

#### è¯¦ç»†æ—¥å¿—è®°å½•
```cpp
// è®°å½•å®Œæ•´çš„é‡å¯è¿‡ç¨‹
NFLogInfo(NF_LOG_DEFAULT, 0, "=== Windows Restart Process Started ===");
NFLogInfo(NF_LOG_DEFAULT, 0, "Target Process ID: {}", proc_id);
NFLogInfo(NF_LOG_DEFAULT, 0, "Kill Event Name: {}", killEventName);
NFLogInfo(NF_LOG_DEFAULT, 0, "Success Event Name: {}", killSuccessEventName);

// è®°å½•æ—¶é—´æˆ³
auto start_time = std::chrono::steady_clock::now();
// ... é‡å¯è¿‡ç¨‹ ...
auto end_time = std::chrono::steady_clock::now();
auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end_time - start_time);

NFLogInfo(NF_LOG_DEFAULT, 0, "Restart completed in {} ms", duration.count());
```

#### æ€§èƒ½æŒ‡æ ‡ç›‘æ§
```cpp
struct RestartMetrics
{
    uint64_t total_restarts = 0;
    uint64_t successful_restarts = 0;
    uint64_t timeout_failures = 0;
    uint64_t error_failures = 0;
    double average_restart_time = 0.0;
    
    void RecordRestart(bool success, uint64_t duration_ms)
    {
        total_restarts++;
        if (success)
        {
            successful_restarts++;
        }
        
        // æ›´æ–°å¹³å‡é‡å¯æ—¶é—´
        average_restart_time = (average_restart_time * (total_restarts - 1) + duration_ms) / total_restarts;
    }
};
```

## ä¸ƒã€æ•…éšœæ’æŸ¥æŒ‡å—

### 7.1 å¸¸è§é—®é¢˜è¯Šæ–­

#### é—®é¢˜1ï¼šäº‹ä»¶åˆ›å»ºå¤±è´¥
```cpp
HANDLE hEvent = CreateEventA(NULL, FALSE, FALSE, eventName.c_str());
if (hEvent == NULL)
{
    DWORD error = GetLastError();
    NFLogError(NF_LOG_DEFAULT, 0, "Failed to create event {}, error: {}", eventName, error);
    
    // å¸¸è§é”™è¯¯ç ï¼š
    // ERROR_ALREADY_EXISTS (183): äº‹ä»¶å·²å­˜åœ¨
    // ERROR_ACCESS_DENIED (5): æƒé™ä¸è¶³
    // ERROR_INVALID_NAME (123): äº‹ä»¶åç§°æ— æ•ˆ
}
```

#### é—®é¢˜2ï¼šç­‰å¾…è¶…æ—¶
```cpp
if (waitResult == WAIT_TIMEOUT)
{
    // å¯èƒ½åŸå› ï¼š
    // 1. ç¨‹åºBæœªæ­£å¸¸è¿è¡Œ
    // 2. ç¨‹åºBäº‹ä»¶å¤„ç†çº¿ç¨‹å¼‚å¸¸
    // 3. ç³»ç»Ÿè´Ÿè½½è¿‡é«˜
    
    // è¯Šæ–­æ­¥éª¤ï¼š
    // 1. æ£€æŸ¥ç¨‹åºBè¿›ç¨‹æ˜¯å¦å­˜åœ¨
    // 2. æ£€æŸ¥ç¨‹åºBæ—¥å¿—æ–‡ä»¶
    // 3. æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
}
```

#### é—®é¢˜3ï¼šå…±äº«å†…å­˜ä¸¢å¤±
```cpp
// æ£€æŸ¥å…±äº«å†…å­˜é…ç½®
if (busLength < minimumRequiredSize)
{
    NFLogError(NF_LOG_DEFAULT, 0, "Shared memory size {} is too small, minimum required: {}", 
               busLength, minimumRequiredSize);
}

// éªŒè¯æ•°æ®å®Œæ•´æ€§
bool ValidateSharedMemoryData()
{
    // æ£€æŸ¥å…³é”®æ•°æ®ç»“æ„
    // éªŒè¯æ•°æ®å®Œæ•´æ€§
    // è®°å½•æ•°æ®çŠ¶æ€
}
```

### 7.2 è°ƒè¯•å·¥å…·å’ŒæŠ€å·§

#### Windowsäº‹ä»¶æŸ¥çœ‹å™¨
```bash
# æŸ¥çœ‹åº”ç”¨ç¨‹åºæ—¥å¿—
eventvwr.msc

# è¿‡æ»¤NFPluginLoaderç›¸å…³äº‹ä»¶
# åº”ç”¨ç¨‹åºå’ŒæœåŠ¡æ—¥å¿— -> Windowsæ—¥å¿— -> åº”ç”¨ç¨‹åº
```

#### è¿›ç¨‹ç›‘æ§
```bash
# æŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨
tasklist | findstr NFPluginLoader

# æŸ¥çœ‹è¿›ç¨‹è¯¦ç»†ä¿¡æ¯
wmic process where "name='NFPluginLoader.exe'" get ProcessId,CommandLine,CreationDate

# ç›‘æ§è¿›ç¨‹èµ„æºä½¿ç”¨
perfmon.exe
```

#### äº‹ä»¶è°ƒè¯•
```cpp
// è°ƒè¯•æ¨¡å¼ä¸‹çš„è¯¦ç»†æ—¥å¿—
#ifdef _DEBUG
    NFLogDebug(NF_LOG_DEFAULT, 0, "Event {} created with handle {}", eventName, (void*)hEvent);
    NFLogDebug(NF_LOG_DEFAULT, 0, "Waiting for event {} with timeout {} ms", eventName, timeout);
    NFLogDebug(NF_LOG_DEFAULT, 0, "Event {} wait result: {}", eventName, waitResult);
#endif
```

## å…«ã€æœ€ä½³å®è·µå»ºè®®

### 8.1 å¼€å‘è°ƒè¯•ä¸“ç”¨é…ç½®

**âš ï¸ é‡è¦æé†’ï¼šä»¥ä¸‹é…ç½®ä»…é€‚ç”¨äºå¼€å‘è°ƒè¯•ç¯å¢ƒ**

```lua
-- Windowså¹³å°å¼€å‘è°ƒè¯•é…ç½®ï¼ˆä»…é™å¼€å‘ç¯å¢ƒï¼‰
GameServer = {
    GameServer_1 = {
        BusLength = 20971520,          -- 20Må…±äº«å†…å­˜ï¼Œç¡®ä¿è¶³å¤Ÿå¤§
        HandleMsgNumPerFrame = 1000,   -- é€‚å½“é™ä½æ¯å¸§å¤„ç†æ¶ˆæ¯æ•°
        IdleSleepUS = 1000,           -- ç©ºé—²ä¼‘çœ æ—¶é—´
        -- å¼€å‘è°ƒè¯•ä¸“ç”¨æ ‡å¿—
        DebugMode = true,             -- å¯ç”¨è°ƒè¯•æ¨¡å¼
        DataBackupEnabled = true,     -- å¯ç”¨æ•°æ®å¤‡ä»½
        -- å…¶ä»–é…ç½®...
    }
}

-- é‡å¯ç­–ç•¥é…ç½®ï¼ˆå¼€å‘è°ƒè¯•ä¸“ç”¨ï¼‰
RestartConfig = {
    KillTimeout = 15000,           -- Killä¿¡å·ç­‰å¾…è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
    AutoExitTimeout = 10000,       -- è‡ªåŠ¨é€€å‡ºè¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
    EventProcessDelay = 50,        -- äº‹ä»¶å¤„ç†å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    MaxRetryCount = 3,             -- æœ€å¤§é‡è¯•æ¬¡æ•°
    -- æ•°æ®ä¿æŠ¤é…ç½®
    AutoBackupBeforeRestart = true, -- é‡å¯å‰è‡ªåŠ¨å¤‡ä»½
    DataValidationEnabled = true,   -- å¯ç”¨æ•°æ®éªŒè¯
}
```

### 8.2 å¼€å‘ç¯å¢ƒéƒ¨ç½²å»ºè®®

**ç¯å¢ƒå‡†å¤‡**ï¼š
1. **ä¸“ç”¨å¼€å‘æœºå™¨**ï¼šä½¿ç”¨ç‹¬ç«‹çš„å¼€å‘æœºå™¨ï¼Œé¿å…å½±å“å…¶ä»–å·¥ä½œ
2. **æ•°æ®éš”ç¦»**ï¼šä½¿ç”¨æµ‹è¯•æ•°æ®ï¼Œä¸è¦ä½¿ç”¨ä»»ä½•é‡è¦æ•°æ®
3. **å®šæœŸå¤‡ä»½**ï¼šå»ºç«‹è‡ªåŠ¨å¤‡ä»½æœºåˆ¶ï¼Œå®šæœŸä¿å­˜å¼€å‘è¿›åº¦
4. **ç‰ˆæœ¬æ§åˆ¶**ï¼šç¡®ä¿ä»£ç å’Œé…ç½®æ–‡ä»¶åœ¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­

**å®‰å…¨æªæ–½**ï¼š
1. **æƒé™è®¾ç½®**ï¼šç¡®ä¿è¿›ç¨‹æœ‰è¶³å¤Ÿæƒé™åˆ›å»ºå‘½åäº‹ä»¶
2. **é˜²ç—…æ¯’è½¯ä»¶**ï¼šå°†NFPluginLoaderåŠ å…¥é˜²ç—…æ¯’è½¯ä»¶ç™½åå•
3. **ç³»ç»Ÿèµ„æº**ï¼šç¡®ä¿ç³»ç»Ÿæœ‰è¶³å¤Ÿå†…å­˜å’ŒCPUèµ„æº
4. **ç½‘ç»œé…ç½®**ï¼šç¡®ä¿é˜²ç«å¢™ä¸é˜»æ­¢è¿›ç¨‹é—´é€šä¿¡

### 8.3 æ•°æ®ä¿æŠ¤å’Œç›‘æ§å»ºè®®

**æ•°æ®ä¿æŠ¤è„šæœ¬**ï¼š
```batch
@echo off
REM Windowså¼€å‘ç¯å¢ƒæ•°æ®ä¿æŠ¤è„šæœ¬

REM 1. é‡å¯å‰æ•°æ®å¤‡ä»½
echo Creating backup before restart...
set BACKUP_DIR=backup_%date:~0,4%%date:~5,2%%date:~8,2%_%time:~0,2%%time:~3,2%%time:~6,2%
mkdir %BACKUP_DIR%
xcopy /E /I shared_memory_data %BACKUP_DIR%\shared_memory_data
xcopy /E /I logs %BACKUP_DIR%\logs

REM 2. æ‰§è¡Œé‡å¯
echo Starting restart process...
NFPluginLoader.exe --Server=GameServer --ID=1.13.10.1 --Plugin=LieRenPlugin --Restart

REM 3. éªŒè¯æ•°æ®å®Œæ•´æ€§
echo Validating data integrity...
call verify_data_integrity.bat
if errorlevel 1 (
    echo Data validation failed! Restoring backup...
    call restore_backup.bat %BACKUP_DIR%
    exit /b 1
)

echo Restart completed successfully!
```

**ç›‘æ§è„šæœ¬**ï¼š
```cpp
// é‡å¯ç›‘æ§ï¼ˆå¼€å‘è°ƒè¯•ä¸“ç”¨ï¼‰
class DevelopmentRestartMonitor
{
public:
    void MonitorRestart(const std::string& serverId)
    {
        // é‡å¯å‰æ£€æŸ¥
        if (!PreRestartCheck())
        {
            NFLogError(NF_LOG_DEFAULT, 0, "Pre-restart check failed, aborting restart");
            return;
        }
        
        // æ•°æ®å¤‡ä»½
        BackupCriticalData();
        
        auto start = std::chrono::steady_clock::now();
        
        // æ‰§è¡Œé‡å¯
        int result = ExecuteRestart(serverId);
        
        auto end = std::chrono::steady_clock::now();
        auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end - start);
        
        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        if (result == 0 && ValidateDataIntegrity())
        {
            NFLogInfo(NF_LOG_DEFAULT, 0, "Development restart completed successfully in {} ms", duration.count());
            CleanupOldBackups();  // æ¸…ç†æ—§å¤‡ä»½
        }
        else
        {
            NFLogError(NF_LOG_DEFAULT, 0, "Development restart failed or data validation failed");
            RestoreFromBackup();  // æ¢å¤å¤‡ä»½
        }
    }
    
private:
    bool PreRestartCheck()
    {
        // æ£€æŸ¥æ˜¯å¦åœ¨å¼€å‘ç¯å¢ƒ
        if (!IsDebugEnvironment())
        {
            NFLogError(NF_LOG_DEFAULT, 0, "Windows restart is only allowed in development environment!");
            return false;
        }
        
        // æ£€æŸ¥ç³»ç»Ÿèµ„æº
        if (!CheckSystemResources())
        {
            NFLogWarning(NF_LOG_DEFAULT, 0, "System resources low, restart may be risky");
        }
        
        return true;
    }
};
```

### 8.4 æ•…éšœæ¢å¤é¢„æ¡ˆ

**æ•°æ®ä¸¢å¤±æ¢å¤æµç¨‹**ï¼š
```batch
REM æ•°æ®ä¸¢å¤±ç´§æ€¥æ¢å¤è„šæœ¬
@echo off
echo ========================================
echo   Windowsçƒ­æ›´æ•°æ®ä¸¢å¤±æ¢å¤è„šæœ¬
echo   ä»…é™å¼€å‘ç¯å¢ƒä½¿ç”¨
echo ========================================

REM 1. åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
echo Stopping all processes...
taskkill /F /IM NFPluginLoader.exe

REM 2. æŸ¥æ‰¾æœ€æ–°å¤‡ä»½
echo Finding latest backup...
for /f "delims=" %%i in ('dir /b /ad backup_* ^| sort /r') do (
    set LATEST_BACKUP=%%i
    goto :found_backup
)
:found_backup

if "%LATEST_BACKUP%"=="" (
    echo No backup found! Data recovery failed.
    pause
    exit /b 1
)

echo Latest backup found: %LATEST_BACKUP%

REM 3. æ¢å¤æ•°æ®
echo Restoring data from backup...
rmdir /S /Q shared_memory_data
xcopy /E /I %LATEST_BACKUP%\shared_memory_data shared_memory_data

REM 4. éªŒè¯æ¢å¤ç»“æœ
echo Validating restored data...
call verify_data_integrity.bat
if errorlevel 1 (
    echo Data restoration validation failed!
    pause
    exit /b 1
)

echo Data recovery completed successfully!
echo You can now restart the server normally.
pause
```

**å¼€å‘å›¢é˜Ÿåä½œå»ºè®®**ï¼š
1. **å…±äº«é£é™©è®¤çŸ¥**ï¼šç¡®ä¿æ‰€æœ‰å¼€å‘äººå‘˜äº†è§£Windowsçƒ­æ›´çš„é£é™©
2. **ç»Ÿä¸€å¼€å‘ç¯å¢ƒ**ï¼šå»ºç«‹æ ‡å‡†çš„å¼€å‘ç¯å¢ƒé…ç½®
3. **å®šæœŸæ•°æ®åŒæ­¥**ï¼šå®šæœŸåŒæ­¥é‡è¦çš„æµ‹è¯•æ•°æ®
4. **ç´§æ€¥è”ç³»æœºåˆ¶**ï¼šå»ºç«‹æ•°æ®ä¸¢å¤±æ—¶çš„ç´§æ€¥è”ç³»å’Œæ¢å¤æœºåˆ¶

## ä¹ã€ä¸Linuxå¹³å°å¯¹æ¯”

### 9.1 åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | Linuxå®ç° | Windowså®ç° |
|------|-----------|-------------|
| **è¿›ç¨‹é€šä¿¡** | ä¿¡å·æœºåˆ¶ | å‘½åäº‹ä»¶ |
| **ç¡®è®¤æœºåˆ¶** | å•å‘ + è¿›ç¨‹æ£€æµ‹ | åŒå‘ç¡®è®¤ |
| **è¶…æ—¶å¤„ç†** | 10ç§’ + SIGKILL | 15ç§’ç­‰å¾… + 10ç§’è‡ªåŠ¨é€€å‡º |
| **ç«æ€æ¡ä»¶** | ä¿¡å·é˜Ÿåˆ— | å»¶è¿Ÿ + è½®è¯¢ |
| **é”™è¯¯æ¢å¤** | å¼ºåˆ¶æ€æ­» | è¶…æ—¶ç»§ç»­ |
| **èµ„æºæ¸…ç†** | è‡ªåŠ¨ | æ‰‹åŠ¨ç®¡ç† |

### 9.2 æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Linux | Windows |
|------|-------|---------|
| **é‡å¯æ—¶é—´** | 2-3ç§’ | 3-5ç§’ |
| **CPUå¼€é”€** | ä½ | ä¸­ç­‰ |
| **å†…å­˜å¼€é”€** | ä½ | ä¸­ç­‰ |
| **å¯é æ€§** | é«˜ | é«˜ |
| **å¤æ‚åº¦** | ä½ | ä¸­ç­‰ |

## åã€æ€»ç»“

Windowså¹³å°çš„çƒ­æ›´é‡å¯å®ç°è™½ç„¶åœ¨æŠ€æœ¯ä¸Šå¯è¡Œï¼Œä½†å­˜åœ¨ä¸¥é‡çš„æ•°æ®å®‰å…¨é£é™©ï¼Œ**ä»…é€‚ç”¨äºå¼€å‘è°ƒè¯•ç¯å¢ƒ**ã€‚

### 10.1 é£é™©æ€»ç»“
1. **æ•°æ®å®‰å…¨é£é™©**ï¼šWindowså…±äº«å†…å­˜æœºåˆ¶ä¸ç¨³å®šï¼Œå®¹æ˜“å¯¼è‡´æ•°æ®å®Œå…¨ä¸¢å¤±
2. **ç³»ç»Ÿä¾èµ–é£é™©**ï¼šä¾èµ–å¤æ‚çš„åŒå‘ç¡®è®¤æœºåˆ¶ï¼Œä»»ä½•ç¯èŠ‚å¤±è´¥éƒ½å¯èƒ½é€ æˆé—®é¢˜
3. **ç¯å¢ƒå…¼å®¹é£é™©**ï¼šä¸åŒWindowsç‰ˆæœ¬å’Œç³»ç»Ÿé…ç½®å¯èƒ½å¯¼è‡´ä¸ä¸€è‡´çš„è¡Œä¸º
4. **æ¢å¤æˆæœ¬é£é™©**ï¼šæ•°æ®ä¸¢å¤±åçš„æ¢å¤æˆæœ¬å’Œæ—¶é—´æˆæœ¬æé«˜

### 10.2 ä½¿ç”¨é™åˆ¶
- **ä¸¥æ ¼é™åˆ¶åœ¨å¼€å‘è°ƒè¯•ç¯å¢ƒ**ï¼šç»å¯¹ä¸èƒ½ç”¨äºç”Ÿäº§ç¯å¢ƒ
- **å¿…é¡»æœ‰å®Œå–„çš„æ•°æ®å¤‡ä»½æœºåˆ¶**ï¼šæ¯æ¬¡é‡å¯å‰éƒ½è¦å¤‡ä»½å…³é”®æ•°æ®
- **éœ€è¦ä¸“ä¸šçš„è¿ç»´çŸ¥è¯†**ï¼šæ“ä½œäººå‘˜å¿…é¡»å……åˆ†ç†è§£é£é™©å’Œæ¢å¤æµç¨‹
- **å»ºè®®è¿ç§»åˆ°Linuxå¹³å°**ï¼šè·å¾—æ›´ç¨³å®šå¯é çš„çƒ­æ›´æ–°æ”¯æŒ

### 10.3 æŠ€æœ¯æˆæœï¼ˆä»…é™å¼€å‘è°ƒè¯•ï¼‰
1. **åŒå‘ç¡®è®¤æœºåˆ¶**ï¼šåœ¨Windowså¹³å°å®ç°äº†ç›¸å¯¹å®‰å…¨çš„é‡å¯æ–¹æ¡ˆ
2. **äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼šé«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶
3. **ç«æ€æ¡ä»¶å¤„ç†**ï¼šå®Œå–„çš„æ—¶åºæ§åˆ¶
4. **è¯¦ç»†ç›‘æ§æ—¥å¿—**ï¼šä¾¿äºé—®é¢˜è¯Šæ–­å’Œæ¢å¤

### 10.4 ç”Ÿäº§ç¯å¢ƒå»ºè®®
å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œå¼ºçƒˆå»ºè®®ï¼š
1. **ä½¿ç”¨Linuxå¹³å°**ï¼šè·å¾—çœŸæ­£ç¨³å®šçš„é›¶æ•°æ®ä¸¢å¤±çƒ­æ›´æ–°
2. **ä¼ ç»Ÿåœæœæ›´æ–°**ï¼šä½¿ç”¨æˆç†Ÿç¨³å®šçš„åœæœ-æ›´æ–°-å¯æœæµç¨‹
3. **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šä½¿ç”¨Dockerç­‰å®¹å™¨æŠ€æœ¯å®ç°å¿«é€Ÿéƒ¨ç½²
4. **ç°åº¦å‘å¸ƒç­–ç•¥**ï¼šé€æ­¥æ›´æ–°ï¼Œé™ä½é£é™©

### 10.5 æœ€ç»ˆå»ºè®®
**Windowså¹³å°çš„çƒ­æ›´é‡å¯åŠŸèƒ½åº”è¯¥è¢«è§†ä¸ºä¸€ä¸ªå¼€å‘è°ƒè¯•å·¥å…·ï¼Œè€Œä¸æ˜¯ç”Ÿäº§è§£å†³æ–¹æ¡ˆ**ã€‚å®ƒçš„å­˜åœ¨ä»·å€¼åœ¨äºï¼š
- å¸®åŠ©å¼€å‘è€…åœ¨Windowsç¯å¢ƒä¸‹è¿›è¡Œä»£ç è°ƒè¯•
- æä¾›è·¨å¹³å°å¼€å‘çš„ä¾¿åˆ©æ€§
- ä½œä¸ºæŠ€æœ¯éªŒè¯å’Œå­¦ä¹ çš„æ¡ˆä¾‹

ä½†æ˜¯ï¼Œå¯¹äºä»»ä½•åŒ…å«é‡è¦æ•°æ®æˆ–é¢å‘ç”¨æˆ·çš„ç¯å¢ƒï¼Œéƒ½åº”è¯¥é¿å…ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œè½¬è€Œé‡‡ç”¨æ›´å®‰å…¨å¯é çš„æ›¿ä»£æ–¹æ¡ˆã€‚

**è®°ä½ï¼šæ•°æ®å®‰å…¨æ°¸è¿œæ¯”ä¾¿åˆ©æ€§æ›´é‡è¦ï¼** 